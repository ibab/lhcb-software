
c*******************************************************
c... open files for recording grid generated by vegas and 
c... for recording the intermediate running information
c... e.g. (.grid)---> for grid; (.cs)---> for cross-section.
c*******************************************************

      subroutine upopenfile
      implicit double precision(a-h, o-z)
	implicit integer(i-n)

	common/counter/ixiccstate,nev,xmaxwgt
	common/mixevnt/imix,imixtype
	common/funtrans/npdfu
	common/sub open/subfactor,subenergy,isubonly,ichange,iconsbarnum
	common/mtypeofxi/mgenxi
      common/wbstate/ratiou,ratiod,ratios,nbound
      common/loggrade/ievntdis,igenerate,ivegasopen,igrade,iusecurdir
      common/upcom/ecm,pmxicc,pmb,pmc,fxicc,pmomup(5,8),
     &  colmat(6,64),bundamp(4),pmomzero(5,8)

      ! Added by F. Zhang 22-04-2011
      ! for the FULLPATHNAME of the file ".cs" and ".grid"
      CHARACTER*472 BASENAME1,BASENAME2,ENERGYNAME
      CHARACTER*472 FULLPATHNAME1,FULLPATHNAME2

	character*23  foname(2)
	character  fn1*21, fn2*23, dirx*11
	common/namedir/dirx
	common/usedbyveg/fn2,BASENAME2,ENERGYNAME ! F. Zhang 23-04-2011

	logical gg3s1c3,gc3s1c3,cc3s1c3
	logical gg1s0c6,gc1s0c6,cc1s0c6
	logical gg3s1c6,gg1s0c3
	logical mixgg,mixgc,mixcc
c----------------------
c     ! Added by F. Zhang 23-04-2011
      CALL GETENV( 'PWD' , BASENAME1 )
      CALL GETENV( 'GENXICCDATAROOT' , BASENAME2 )
C----------------------
C     ! Added by F. ZHANG 11-10-2012
C.....For reading grid files for different center of mass energy
      IF( ABS(ECM-14000).LE.1. )THEN
        ENERGYNAME='data/14TeV/'
      ELSE IF( ABS(ECM-13000).LE.1. )THEN
        ENERGYNAME='data/13TeV/'
      ELSE IF( ABS(ECM-8000).LE.1.  )THEN
        ENERGYNAME='data/8TeV/'
      ELSE IF( ABS(ECM-7000).LE.1.  )THEN
        ENERGYNAME='data/7TeV/'
      ELSE
        ENERGYNAME='***Not-Supported-Energy***/'
        WRITE(*,*) "***************************************************"
        WRITE(*,*) "The energy " ,ECM," GeV is not supported in GenXicc"
        WRITE(*,*) "***************************************************"
      ENDIF

	
c----------------------
	gg3s1c3=.false.
	gc3s1c3=.false.
	cc3s1c3=.false.
	gg1s0c6=.false.
	gc1s0c6=.false.
	cc1s0c6=.false.
	gg3s1c6=.false.
	gg1s0c3=.false.

	mixgg  =.false.
	mixgc  =.false.
	mixcc  =.false.

c--------------------

      if(isubonly.eq.0) then
       if(imix.eq.0) then
	  if(mgenxi.eq.1) then
	   if(ixiccstate.eq.1) gg3s1c3=.true.
	   if(ixiccstate.eq.2) gg1s0c6=.true.
	   if(ixiccstate.eq.3) gc3s1c3=.true.
	   if(ixiccstate.eq.4) gc1s0c6=.true.
	   if(ixiccstate.eq.5) cc3s1c3=.true.
	   if(ixiccstate.eq.6) cc1s0c6=.true.
	  end if
	  if(mgenxi.eq.2) then
	   if(ixiccstate.eq.1) gg3s1c3=.true.
	   if(ixiccstate.eq.2) gg1s0c6=.true.
	   if(ixiccstate.eq.3) gg3s1c6=.true.
	   if(ixiccstate.eq.4) gg1s0c3=.true.
	  end if
	  if(mgenxi.eq.3) then
	   if(ixiccstate.eq.1) gg3s1c3=.true.
	   if(ixiccstate.eq.2) gg1s0c6=.true.
	  end if
	 end if

c--------------------

	 if(imix.eq.1) then
	  if(mgenxi.eq.1) then
	   if(imixtype.eq.1) mixgg=.true.
	   if(imixtype.eq.2) mixgc=.true.
	   if(imixtype.eq.3) mixcc=.true.
	  end if
	  if(mgenxi.eq.2) then
	   if(imixtype.eq.1) mixgg=.true.
	   if(imixtype.eq.2) mixgg=.true.
	  end if
	  if(mgenxi.eq.3) then
	   if(imixtype.eq.1) mixgg=.true.
	  end if
	 end if
	end if

c-----------------------

	if(isubonly.eq.1) then
	  if(mgenxi.eq.1) then
	   if(ixiccstate.eq.1) gg3s1c3=.true.
	   if(ixiccstate.eq.2) gg1s0c6=.true.
	  end if
	  if(mgenxi.eq.2) then
	   if(ixiccstate.eq.1) gg3s1c3=.true.
	   if(ixiccstate.eq.2) gg1s0c6=.true.
	   if(ixiccstate.eq.3) gg3s1c6=.true.
	   if(ixiccstate.eq.4) gg1s0c3=.true.
	  end if
	  if(mgenxi.eq.3) then
	   if(ixiccstate.eq.1) gg3s1c3=.true.
	   if(ixiccstate.eq.2) gg1s0c6=.true.
	  end if
	end if

c--------------------

c******************************
c...data files.
c...record usual data: pt--xicc p_t; rap--xicc rapidity; shat--
c...the subprocess c.m.energy; y--rapidity but equal to 
c...ln((x1-x2)/(x1+x2)); pseta--xicc pseudo-rapidity; 
c...z--(2(k1+k2).p_xicc)/(square of the subprocess energy);
c******************************
	
	if(mgenxi.eq.1) then
	  do i=1,2
	    if(nbound.eq.1) foname(i)(1:11)='data/xiccu/'
	    if(nbound.eq.2) foname(i)(1:11)='data/xiccd/' ! F. Zhang 25-04-2011
	    if(nbound.eq.3) foname(i)(1:11)='data/xiccs/'
	    if(nbound.eq.4) foname(i)(1:11)='data/ccdiq/'
	  end do
	end if

	if(mgenxi.eq.2) then
	  do i=1,2
	    if(nbound.eq.1) foname(i)(1:11)='data/xibcu/'
	    if(nbound.eq.2) foname(i)(1:11)='data/xibcd/'
	    if(nbound.eq.3) foname(i)(1:11)='data/xibcs/'
	    if(nbound.eq.4) foname(i)(1:11)='data/bcdiq/'
	  end do
	end if

	if(mgenxi.eq.3) then
	  do i=1,2
	    if(nbound.eq.1) foname(i)(1:11)='data/xibbu/'
	    if(nbound.eq.2) foname(i)(1:11)='data/xibbd/'
	    if(nbound.eq.3) foname(i)(1:11)='data/xibbs/'
	    if(nbound.eq.4) foname(i)(1:11)='data/bbdiq/'
	  end do
	end if

c...record which dirrectory the data are put
      dirx=foname(1)

c...file about the generated grade by vegas.
       foname(1)(19:21)='.cs'
       foname(2)(19:23)='.grid'
        
c=============================

	if(gg3s1c3) then
	 do i=1,2
	    foname(i)(12:18)='gg3s1c3'
	 end do
	end if

	if(gg1s0c6) then
	 do i=1,2
	    foname(i)(12:18)='gg1s0c6'
	 end do
	end if

	if(gg3s1c6) then
	 do i=1,2
	    foname(i)(12:18)='gg3s1c6'
	 end do
	end if

	if(gg1s0c3) then
	 do i=1,2
	    foname(i)(12:18)='gg1s0c3'
	 end do
	end if

	if(gc3s1c3) then
	 do i=1,2
	    foname(i)(12:18)='gc3s1c3'
	 end do
	end if

	if(gc1s0c6) then
	 do i=1,2
	    foname(i)(12:18)='gc1s0c6'
	 end do
	end if

	if(cc3s1c3) then
	 do i=1,2
	    foname(i)(12:18)='cc3s1c3'
	 end do
	end if

	if(cc1s0c6) then
	 do i=1,2
	    foname(i)(12:18)='cc1s0c6'
	 end do
	end if

c======mixing events

	if(mixgg) then
	 do i=1,2
	    foname(i)(12:18)='admixgg'
	 end do
	end if

	if(mixgc) then
	 do i=1,2
	    foname(i)(12:18)='admixgc'
	 end do
	end if

	if(mixcc) then
	 do i=1,2
	    foname(i)(12:18)='admixcc'
	 end do
	end if

c==============================
c...file about the generated grade by vegas.
c...! the path of Files (".cs" and ".grid") modefied by F. Zhang 23-04-2011

      fn1=foname(1)
      fn2=foname(2)

      FULLPATHNAME1 = BASENAME1(1:LEN_TRIM(BASENAME1))//'/'  ! ".cs"
     &                 //ENERGYNAME(1:len_trim(ENERGYNAME))
     &                 //FN1(1:LEN_TRIM(FN1))
      if(iusecurdir.eq.1) then
      FULLPATHNAME2 = foname(2)(12:23)
         write(*,*)'NOTE: I use current directory, the FILE name
     &is    ', FULLPATHNAME2, ' iusecurdir = ', iusecurdir
      else
      FULLPATHNAME2 = BASENAME2(1:LEN_TRIM(BASENAME2))//'/'  ! ".grid"
     &                 //ENERGYNAME(1:len_trim(ENERGYNAME))
     &                 //FN2(1:LEN_TRIM(FN2))
         write(*,*)'NOTE: I use SYSTEM  directory, the FILE name
     &is    ', FULLPATHNAME2, ' iusecurdir = ', iusecurdir
      endif

c      open(unit=3,  file=FULLPATHNAME1,status='unknown') ! ".cs"
      open(unit=11, file=FULLPATHNAME2,status='unknown') ! ".grid" 

	return
	end

