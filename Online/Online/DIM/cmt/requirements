#============================================================================
package           DIM
version           v19r8p2
#============================================================================
use GaudiPolicy   v*
branches          cmt src

make_fragment buildproto

tag i486
tag slc3_i486_gcc323      slc3_gcc323 i486
tag slc3_i486_gcc323_dbg  slc3_gcc323 i486 debug
tag slc4_i486_gcc34       slc3_gcc34  i486
tag slc4_i486_gcc34_dbg   slc3_gcc34  i486 debug

macro_append cpp          "" i486 " -m32 -march=i486 "
macro_append cc           "" i486 " -m32 -march=i486 "
macro_append shlibbuilder "" i486 " -m32 -march=i486 "

macro_remove  cflags '' WIN32 '-fmessage-length=0 -fPIC'
pattern dim_exe \
    application  <name>  <files> ; \
    macro_append <name>_cflags  " $(<package>_cppflags)" ; \
    macro_append <name>linkopts " $(cpplinkflags) $(DIM_linkopts) " ; \
    macro_append <name>_dependencies " dim "

apply_pattern install_more_includes more=dim 

macro_append  use_includes ' $(ppcmd)"$(DIM_cmtpath)/$(cmt_installarea_prefix)/include/dim" '
# ==================== component libraries ==================================
library dim conn_handler.c copy_swap.c dic.c dim_thr.c dis.c dll.c dna.c \
            dtq.c hash.c open_dns.c sll.c swap.c tcpip.c \
            utilities.c diccpp.cxx dimcpp.cxx discpp.cxx tokenstring.cxx

apply_pattern linker_library library=dim 
macro_append dim_shlibflags " -lpthread -lrt " WIN32 " "

apply_pattern dim_exe name=dns files=dns.c 
apply_pattern dim_exe name=did files=did/make_did.c
# The link below is ugly, but the linking is not proper on lxplus
macro_append  didlinkopts " /usr/X11R6/lib/libMrm.so.3 "\
 slc4-ia32                " /usr/X11R6/lib/libMrm.so.3 "\
 slc4-amd64               " -L/usr/X11R6/lib64 -lMrm " \
 target-x86_64            " -L/usr/X11R6/lib64 -lMrm -lXt -lXm " \
 WIN32                    " "

apply_pattern dim_exe name=test_server       files=examples/test_server.c
apply_pattern dim_exe name=test_client       files=examples/test_client.c
#apply_pattern dim_exe name=test_big_server   files=examples/test_big_server.c
#apply_pattern dim_exe name=test_big_client   files=examples/test_big_client.c
# apply_pattern dim_exe name=demo_server     files=examples/demo_server.c
# apply_pattern dim_exe name=demo_client     files=examples/demo_client.c
#apply_pattern dim_exe name=rpc_server        files=examples/rpc_server.cxx
#apply_pattern dim_exe name=rpc_client        files=examples/rpc_client.cxx
#apply_pattern dim_exe name=pvss_dim_server   files=examples/pvss_dim_server.cxx
#apply_pattern dim_exe name=pvss_dim_client   files=examples/pvss_dim_client.cxx
#apply_pattern dim_exe name=benchServer       files=benchmark/benchServer.cxx
#apply_pattern dim_exe name=benchClient       files=benchmark/benchClient.cxx
apply_pattern dim_exe name=check_dns         files=util/check_dns.cxx
apply_pattern dim_exe name=dimbridge         files=util/dimbridge.cxx
apply_pattern dim_exe name=dim_get_service   files=util/dim_get_service.c
apply_pattern dim_exe name=dim_send_command  files=util/dim_send_command.c

# apply_pattern dim_exe name=bigServer       files=benchmark/bigServer.cxx
# apply_pattern dim_exe name=bigClient       files=benchmark/bigClient.cxx

private

macro_append  use_includes ' $(ppcmd)"$(DIMROOT)/dim" '

# temporary fixes
macro cdebugflags   "$(cppdebugflags)"
macro clinkflags    "$(cpplinkflags)"
#macro cflags        "$(cppflags) -Wno-unused "     WIN32 "$(cppflags) /TC"
macro_append DIM_cflags " -Df2cFortran -fPIC -shared -D_GNU_SOURCE"  WIN32 " $(cppflags) /TC"
macro_append DIM_cflags " -Dlinux -Dunix -pipe -ansi -Wall -Wextra"  WIN32 ""
macro_append DIM_cflags " -pthread  -Wno-unused "                    WIN32 ""


# local compile options
macro_append DIM_cppflags      " -DPROTOCOL=1 -DMIPSEL "
macro_append DIM_cflags        " -DPROTOCOL=1 -DMIPSEL "
macro_remove DIM_cflags        "-Wno-deprecated"
macro_remove DIM_cppflags      "-Wno-deprecated"
